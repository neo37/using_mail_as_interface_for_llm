# Планирование, беклог
## 1. Основные компоненты архитектуры

### A. **Input Layer (Слой приёма сообщений)**  
- **Email Receiver Service**:  
  - Подключается к почтовым серверам (IMAP, POP3) для получения писем.  
  - Может быть расширен для работы с другими каналами (например, SMS, мессенджеры, веб-формы).  
  - Отправляет полученные сообщения в систему обработки (например, через message queue).

### B. **Message Broker / Queue**  
- Использование брокера сообщений (RabbitMQ, Kafka или аналогичного решения) для:
  - **Декуплинга**: Отделения приёма сообщений от их обработки, что позволяет масштабировать систему независимо.  
  - **Надёжной доставки**: Гарантирует, что каждое письмо будет обработано даже при временных сбоях отдельных сервисов.

### C. **Processing Layer (Слой обработки)**  
- **LLM Processing Service (или набор микросервисов)**:
  - **Preprocessing Module**: Предварительная обработка текста письма (очистка, нормализация, извлечение контента из HTML/многочастных сообщений).  
  - **LLM Parser**: Обращается к языковой модели (например, через API GPT-4 или локальную дообученную модель) для извлечения ключевых данных (название продукта, цена, размеры и т.д.).  
  - **Clarification Generator**: Если данные неполные, генерирует уточняющие вопросы с учётом контекста.  
  - **Fallback & Human-in-the-loop Module**: При неоднозначностях или сбоях обработки данные могут быть переданы на ручную проверку.

### D. **Data Management Layer (Слой управления данными)**  
- **Central Database/Storage**:
  - Хранит извлечённые данные, логи обработки, историю коммуникаций с поставщиками.  
  - Может использовать реляционные (PostgreSQL) или NoSQL базы (MongoDB) в зависимости от характера данных.
- **Data Manager Service**:
  - Инкапсулирует бизнес-логику обновления данных, объединения информации от разных писем одного поставщика, проверки полноты данных.

### E. **Integration & Communication Layer**  
- **Email Sender Service**:
  - Отправляет автоматизированные ответы поставщикам (подтверждение получения данных, уточняющие вопросы).  
- **API Gateway / Webhooks**:
  - Для интеграции с внешними системами (CRM, ERP) и предоставления интерфейсов для мониторинга и управления.
- **User Interface / Dashboard**:
  - Административная панель для мониторинга статуса обработки, ручного вмешательства, корректировки результатов LLM.

### F. **Orchestration & Scheduling**  
- **Task Scheduler / Worker System (например, Celery)**:
  - Управляет периодическим опросом новых писем, очередями задач на обработку и отправку сообщений.
- **Workflow Engine**:
  - Определяет последовательность шагов обработки: от получения письма до отправки ответа и сохранения данных. Позволяет гибко задавать правила обработки и маршрутизации.

### G. **Monitoring, Logging & Analytics**  
- **Логирование**: Централизованное хранилище логов (например, ELK-stack, Splunk) для отладки и анализа работы системы.  
- **Мониторинг**: Системы типа Prometheus + Grafana для отслеживания производительности, задержек в очередях и ошибок.  
- **Аналитика**: Сбор метрик по точности извлечения данных, качеству уточняющих вопросов и обратной связи от пользователей.

---

## 2. Пример текстовой схемы архитектуры

```
                  +------------------------+
                  |    Communication       |
                  |     Channels           |
                  | (Email, SMS, Web, etc.)|
                  +-----------+------------+
                              │
                              ▼
                  +------------------------+
                  |   Email Receiver       |
                  |     Microservice       |
                  +-----------+------------+
                              │
                              ▼
                  +------------------------+
                  |     Message Broker     | <-- Может быть Kafka, RabbitMQ
                  +-----------+------------+
                              │
                              ▼
             +----------------------------------+
             |        Processing Layer          |
             |  (Preprocessing, LLM Parser,     |
             |   Clarification Generator, etc.) |
             +-----------+----------------------+
                         │
                         ▼
             +-------------------------+
             |  Data Management Layer  |
             |  (База данных, Data     |
             |   Manager Service)      |
             +-----------+-------------+
                         │
                         ▼
             +-------------------------+
             | Integration &           |
             | Communication Layer     |
             | (Email Sender, API, UI) |
             +-------------------------+
```

---

## 3. Долгосрочное развитие и масштабируемость

- **Модульность и микросервисы**:  
  Разделив систему на независимые модули, можно легко масштабировать отдельные части – например, LLM-сервис можно обновлять или заменять, не затрагивая остальные компоненты.

- **Расширяемость входных каналов**:  
  Добавление поддержки новых источников сообщений (соцсети, чаты) становится простым – достаточно создать адаптеры, которые будут подавать данные в общий message broker.

- **Интеграция новых возможностей LLM**:  
  Сервис обработки может использовать как внешние API, так и локальные модели. При появлении новых моделей или методов дообучения можно легко интегрировать их в существующий pipeline.

- **Адаптивность бизнес-логики**:  
  Использование workflow engine позволяет задавать сложные сценарии обработки, корректируя алгоритмы на основе обратной связи и накопленных данных.

- **Мониторинг и анализ**:  
  Постоянный сбор метрик и логов позволит выявлять «узкие места» и на их основе проводить оптимизацию процессов или корректировать алгоритмы LLM.

---

## Итог

Общая архитектура представляет собой набор модульных, слабо связанных сервисов, которые взаимодействуют через очереди сообщений и API. Такой подход позволяет:

- Гибко расширять функциональность (новые каналы, новые параметры для извлечения, мультиязычность).  
- Масштабировать систему по мере роста объёма входящих сообщений и сложности обработки.  
- Быстро адаптироваться к изменениям в бизнес-требованиях или технологиях, интегрируя новые решения для улучшения LLM и связанных модулей.
